# Relay for Frontend and Sdw
 Since the aiweb3 frontend is on VPS and the SDW is on the local machine with private IP, we need to utilize this project as the relay on both sides to connect them. 

# Part I: Relay at the AI side
Before running the relay at the AI side, we need to install the SDW and run it as a service.
## Install stable diffussion webui
1. Since there are some difference with respect to the platform, plz find the best way to install SDW https://github.com/AUTOMATIC1111/stable-diffusion-webui
2. For now, we use the model darkSushiMixMix_225D , which can be download at https://civitai.com/models/24779/dark-sushi-mix-mix ,where the model should be put in the folder /models/Stable-diffusion (if using lora, so should be put in Lora folder)

## Run SDW as a service
```
conda activate xxx (this is the name of the conda environment)

bash webui.sh --nowebui --gradio-auth admin:admin123   (more args: https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Command-Line-Arguments-and-Settings)
```
## Run the relay (this project)
Now, we can run the relay.
### Install
```
yarn install
```
!!! The package 'stable-diffusion-sdk' has some issue, so we need to modify the its code in node_modules/stable-diffusion-sdk/dist/lib/StableDiffusionApi.js around line 460

```
const modelNames = models.map((model) => model.name);
```
to 
```
const modelNames = models.map((model) => model.model_name);
```

### Add customer parameter into /config 
aiweb3.ts is the config file for managing base prompts, i.e., the NFT style. 

general.ts is the config file for network setting such as the port number and the IP address.

sdw.ts is the config file for the SDW setting such as security token, model name, network parameters.


### Compile 
```
tsc
```


### Run at the AI side


```
node dist/index.js --relaySide ai
```
### Run at the frontend side
```
node dist/index.js --relaySide frontend
```



ðŸ˜†ðŸ˜†ðŸ˜†

# How the frontend interact with the relay


## User login (verfity the user's signature)

The frontend should post data to http://127.0.0.1:1985/verifyUserSignature with the following format
```
{   
    "message": "0xaaaaa is signing in to Aiweb3 at timestamp [current_timestamp] with nonce [random_nonce]", // the message to be signed
    "signature": "0x...", // user's signature for the message
    "userAddress": "0x..."  // user's metamask address
}
```
Here, the port number 1985 is defined in the config file general.ts. Current_timestamp and random_nonce are generated by the frontend, in order to prevent replay attacks (this is important).


## Mint NFT

The frontend should post data to http://127.0.0.1:1985/generateTaskFromFrontend with the following format

```
{   
    "feature": "{\"feature1\":\"red hat\", \"feature2\":\"blue t-shirt\"}, ..."
   
    "userAddress": "0x..."  // user's metamask address
}
```
Here, the feature indicates  the users' bais on their NFT. So, the front end may add a blank where the user can add this information.

